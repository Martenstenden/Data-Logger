name: .NET CI/CD for Data Logger

on:
  push: 
    branches: [ main, develop ]
  pull_request: 
    branches: [ main, develop ]
  workflow_dispatch: 

jobs:
  build-and-unit-test:
    name: Build & Unit Test
    runs-on: windows-latest 

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '4.8.1' 

    - name: Restore dependencies
      run: dotnet restore

    - name: Build solution
      run: dotnet build --configuration Release --no-restore

    - name: Run Unit Tests
      run: dotnet test --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=unit_test_results.trx" --filter "FullyQualifiedName!~IntegrationTests" 

    - name: Upload Unit Test Results (Optioneel)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: unit-test-results
        path: DataLogger.Tests/TestResults/unit_test_results.trx

  integration-test:
    name: Integration Test with Docker OPC UA Server
    runs-on: ubuntu-latest 
    needs: build-and-unit-test 

    services: 
      docker:
        image: docker:dind 
        options: --privileged 

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '4.8.1' 

    - name: Restore dependencies for Test Project
      run: dotnet restore ./DataLogger.Tests 

    - name: Build Test Project (nodig als niet alles gebuild is in vorige job)
      run: dotnet build ./DataLogger.Tests --configuration Release --no-restore

    - name: Check Docker Version
      run: docker --version

    - name: Pull OPC UA Reference Server Image
      run: docker pull ghcr.io/opcfoundation/uanetstandard/refserver:latest
      
    - name: Run Integration Tests
      run: |
        echo "Starting Integration Tests..."
        dotnet test ./DataLogger.Tests --configuration Release --no-build --verbosity normal --filter "FullyQualifiedName~IntegrationTests"
        
      timeout-minutes: 15
